{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
    <div>
        <p class="text-xs font-bold text-gold uppercase tracking-widest mb-1">Base de Dados</p>
        <h1 class="text-4xl font-bold text-slate-800 font-serif flex items-center gap-3">
            {{ table_name }}
            <span id="total-rows" class="text-sm bg-gray-100 text-gray-500 px-3 py-1 rounded-full font-sans font-normal border border-gray-200">
                {{ total_rows }} registos
            </span>
        </h1>
    </div>
    
    <div class="flex gap-3 w-full md:w-auto">
        <!-- Barra de Pesquisa -->
        <div class="flex-grow md:flex-grow-0 relative group">
            <input type="text" 
                   id="search-input"
                   value="{{ search_query }}" 
                   placeholder="Pesquisar em {{ table_name }}..." 
                   class="pl-10 pr-10 py-2.5 w-full md:w-72 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-wine focus:ring-1 focus:ring-wine transition shadow-sm"
                   autocomplete="off">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400 group-hover:text-wine transition"></i>
            <i id="search-spinner" class="fas fa-circle-notch fa-spin absolute right-3 top-3 text-wine opacity-0 transition-opacity"></i>
        </div>

        <a href="/" class="px-5 py-2.5 bg-white border border-gray-200 text-slate-600 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition shadow-sm flex items-center gap-2 whitespace-nowrap">
            <i class="fas fa-arrow-left text-xs"></i> <span class="hidden sm:inline">Voltar</span>
        </a>
    </div>
</div>

<!-- Tabela -->
<div class="glass bg-white rounded-2xl shadow-xl border border-white/50 overflow-hidden mb-6 min-h-[300px]">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-slate-50/80 border-b border-gray-200 text-xs uppercase tracking-wider text-slate-500 font-semibold">
                    <th class="p-5 w-24">ID</th>
                    <th class="p-5">Informação Principal</th>
                    <th class="p-5 text-right w-40">Ações</th>
                </tr>
            </thead>
            <tbody id="results-body" class="divide-y divide-gray-100">
                {% for row in rows %}
                <tr class="table-row-hover transition duration-150 group cursor-pointer" onclick="window.location='/{{ table_name }}/{{ row[pk] }}/'">
                    <td class="p-5">
                        <span class="inline-block px-2 py-1 rounded bg-gray-100 text-slate-500 font-mono text-xs font-bold">
                            #{{ row[pk] }}
                        </span>
                    </td>
                    <td class="p-5 font-medium text-slate-700 text-lg group-hover:text-wine transition-colors">
                        {{ row[display_col] if display_col else row[pk] }}
                    </td>
                    <td class="p-5 text-right">
                        <a href="/{{ table_name }}/{{ row[pk] }}/" class="inline-flex w-8 h-8 items-center justify-center rounded-full bg-pink-50 text-wine hover:bg-wine hover:text-white transition transform hover:scale-110 shadow-sm">
                            <i class="fas fa-arrow-right text-xs"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="empty-state" class="py-16 text-center {{ 'hidden' if rows else '' }}">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 text-gray-400 mb-4">
            <i class="fas fa-search text-2xl"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Sem resultados</h3>
        <p class="text-gray-500 mt-1">Tente pesquisar por outro termo.</p>
    </div>
</div>

<!-- Contentor de Paginação Dinâmica -->
<div id="pagination-container" class="flex justify-center items-center gap-2 pb-8 {{ 'hidden' if total_pages <= 1 else '' }}">
    <!-- Botões gerados pelo servidor inicialmente -->
    <a id="btn-prev" href="{{ url_for('list_table', table_name=table_name, page=page-1, q=search_query) }}" 
       class="w-10 h-10 flex items-center justify-center rounded-lg border {{ 'bg-white hover:bg-slate-50 text-slate-600 border-gray-300 shadow-sm' if page > 1 else 'bg-gray-100 text-gray-400 border-transparent pointer-events-none opacity-50' }} transition">
        <i class="fas fa-chevron-left"></i>
    </a>

    <span id="page-info" class="px-4 text-sm font-medium text-slate-600 bg-white/50 rounded-lg border border-gray-200 h-10 flex items-center">
        Página {{ page }} de {{ total_pages }}
    </span>

    <a id="btn-next" href="{{ url_for('list_table', table_name=table_name, page=page+1, q=search_query) }}" 
       class="w-10 h-10 flex items-center justify-center rounded-lg border {{ 'bg-white hover:bg-slate-50 text-slate-600 border-gray-300 shadow-sm' if page < total_pages else 'bg-gray-100 text-gray-400 border-transparent pointer-events-none opacity-50' }} transition">
        <i class="fas fa-chevron-right"></i>
    </a>
</div>

<script>
    const searchInput = document.getElementById('search-input');
    const resultsBody = document.getElementById('results-body');
    const emptyState = document.getElementById('empty-state');
    const spinner = document.getElementById('search-spinner');
    const totalRowsBadge = document.getElementById('total-rows');
    const paginationContainer = document.getElementById('pagination-container');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageInfo = document.getElementById('page-info');
    
    const tableName = "{{ table_name }}";
    let debounceTimer;

    // Função para atualizar a interface de paginação
    function updatePaginationUI(data, query) {
        // Atualizar texto
        totalRowsBadge.textContent = `${data.total_rows} registos`;
        
        // Mostrar/Esconder paginação
        if (data.total_pages <= 1) {
            paginationContainer.classList.add('hidden');
        } else {
            paginationContainer.classList.remove('hidden');
            
            pageInfo.textContent = `Página ${data.current_page} de ${data.total_pages}`;
            
            // Atualizar botão Anterior
            if (data.current_page > 1) {
                btnPrev.href = `/${tableName}/?page=${data.current_page - 1}&q=${encodeURIComponent(query)}`;
                btnPrev.classList.remove('bg-gray-100', 'text-gray-400', 'border-transparent', 'pointer-events-none', 'opacity-50');
                btnPrev.classList.add('bg-white', 'hover:bg-slate-50', 'text-slate-600', 'border-gray-300', 'shadow-sm');
            } else {
                btnPrev.removeAttribute('href');
                btnPrev.classList.add('bg-gray-100', 'text-gray-400', 'border-transparent', 'pointer-events-none', 'opacity-50');
                btnPrev.classList.remove('bg-white', 'hover:bg-slate-50', 'text-slate-600', 'border-gray-300', 'shadow-sm');
            }

            // Atualizar botão Seguinte
            if (data.current_page < data.total_pages) {
                btnNext.href = `/${tableName}/?page=${data.current_page + 1}&q=${encodeURIComponent(query)}`;
                btnNext.classList.remove('bg-gray-100', 'text-gray-400', 'border-transparent', 'pointer-events-none', 'opacity-50');
                btnNext.classList.add('bg-white', 'hover:bg-slate-50', 'text-slate-600', 'border-gray-300', 'shadow-sm');
            } else {
                btnNext.removeAttribute('href');
                btnNext.classList.add('bg-gray-100', 'text-gray-400', 'border-transparent', 'pointer-events-none', 'opacity-50');
                btnNext.classList.remove('bg-white', 'hover:bg-slate-50', 'text-slate-600', 'border-gray-300', 'shadow-sm');
            }
        }
    }

    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        spinner.classList.remove('opacity-0');

        // Atualizar URL sem recarregar a página para guardar o estado
        const newUrl = new URL(window.location);
        if (query) {
            newUrl.searchParams.set('q', query);
        } else {
            newUrl.searchParams.delete('q');
        }
        newUrl.searchParams.set('page', 1); // Reset para página 1 ao pesquisar
        window.history.pushState({}, '', newUrl);

        debounceTimer = setTimeout(() => {
            fetch(`/${tableName}/?q=${encodeURIComponent(query)}&format=json`)
                .then(response => response.json())
                .then(data => {
                    resultsBody.innerHTML = '';
                    
                    if (data.rows.length === 0) {
                        emptyState.classList.remove('hidden');
                        paginationContainer.classList.add('hidden'); // Esconder paginação se não houver nada
                        totalRowsBadge.textContent = `0 registos`;
                    } else {
                        emptyState.classList.add('hidden');
                        
                        data.rows.forEach(row => {
                            const pkVal = row[data.pk];
                            const displayVal = row[data.display_col] || pkVal;
                            const tr = document.createElement('tr');
                            tr.className = 'table-row-hover transition duration-150 group cursor-pointer border-b border-gray-50 last:border-0';
                            tr.onclick = () => window.location = `/${tableName}/${pkVal}/`;
                            tr.innerHTML = `
                                <td class="p-5"><span class="inline-block px-2 py-1 rounded bg-gray-100 text-slate-500 font-mono text-xs font-bold">#${pkVal}</span></td>
                                <td class="p-5 font-medium text-slate-700 text-lg group-hover:text-wine transition-colors">${displayVal}</td>
                                <td class="p-5 text-right"><a href="/${tableName}/${pkVal}/" class="inline-flex w-8 h-8 items-center justify-center rounded-full bg-pink-50 text-wine hover:bg-wine hover:text-white transition transform hover:scale-110 shadow-sm"><i class="fas fa-arrow-right text-xs"></i></a></td>
                            `;
                            resultsBody.appendChild(tr);
                        });

                        // Atualizar a UI de paginação com os novos dados
                        updatePaginationUI(data, query);
                    }
                    spinner.classList.add('opacity-0');
                })
                .catch(err => {
                    console.error(err);
                    spinner.classList.add('opacity-0');
                });
        }, 300);
    });
</script>
{% endblock %}